---
title: "Guide d'identification de biodiversit√© du Qu√©bec - Partie 1 : les cartes"
description: "Comment les donn√©es de biodiversit√© issues de la science citoyenne permettraient-elles l'√©laboration de d√©pliants d'identification d'esp√®ces?"
bibliography: ../../ref_blg.bib
# csl: ../../evolution.csl
# date: "2025-05-24"
# date: "2025-10-24"
# date: "2025-12-20"
# date: "2026-01-12"
date: "2026-01-19T00:00:01"
categories: ["biodiversit√©", "analyse", "cartes", "tutoriel"]
image: "images/achigans_DSCN1277_2016_08_06.jpeg"
citation: 
  # doi: "10.xxxxx/test"
  url: https://evologie.netlify.app
  language: fr
# number-sections: true
execute: 
  message: false
  warning: false
  # cache: true
editor_options: 
  chunk_output_type: console
---

```{r variable_montre_carte_interactive, echo=FALSE}
# Mettre 'FALSE' pour une exportation rapide du blogue
# TRUE produira toutes les cartes (prend environ 6 min)
intermap_slow = TRUE
```

## Un guide qui s'adapte

Dans le [dernier billet](Guide_biodiv_qc_0.qmd) o√π nous parlions de biodiversit√©, nous avons termin√© sur mon plan pour faire un projet permettant de repr√©senter la biodiversit√© du Qu√©bec dans un d√©pliant. Ce guide d'identification serait bas√© sur les donn√©es de science citoyenne et sur des donn√©es publiques qui nous permettraient de faire des cartes.

Avant de se lancer dans ce billet, qui est un tutoriel pour faire de la cartographie dans R, voici mon plan d√©taill√© pour ce projet.

### Plan et objectifs du projet

Pour ce projet, nous devons remplir quelques objectifs qui seront abord√©s lors de cette s√©rie ¬´¬†Guide d'identification de biodiversit√© du Qu√©bec¬†¬ª :

A)  **Cartographie et spatialisation des donn√©es**

1.1 **Cartographie de r√©f√©rence** : produire une carte avec les MRC du Qu√©bec et les domaines biologiques du Qu√©bec;

1.2 **Identification des zones critiques de biodiversit√©** : obtenir et cartographier des sites ornithologiques ayant un fort volume d'observations issues de la science citoyenne, et qui seront utilis√©es pour mettre en √©vidence des zones √† haut potentiel de biodiversit√©;

2.1 **Inventaire des esp√®ces observ√©es** : √©laborer, pour une r√©gion d'int√©r√™t donn√©e, une liste d'esp√®ces souvent vues par la science citoyenne ;

B)  **Contenu descriptif et visuel pour le d√©pliant (optionnel)**

3.1 **Liste de traits** : Compiler des informations morphologiques (longueur, envergure, poids, etc.) √† int√©grer aux descriptions. Selon le design du d√©pliant, ajouter des √©l√©ments p√©dagogiques comme des trucs mn√©motechniques pour l'identification des oiseaux chanteurs.

3.2 **Portrait photo des organismes** : Int√©grer des photos d'organismes afin d'enrichir le contenu visuel et faciliter l'identification.

La premi√®re partie de cette s√©rie commence par la cartographie (1.1 et 1.2) puisque nous allons avoir besoin de manipuler de l'information spatiale lorsque nous allons travailler avec des donn√©es de biodiversit√© (dans un autre billet de blogue). Plus sp√©cifiquement, nous utiliserons des progiciels[^1] [R](https://cran.r-project.org) pour faire des analyses spatiales. J'assume ici une familiarit√© avec le langage R [@R-base]. Si vous voulez d√©buter avec le langage R, je recommande les <a href='https://r.qcbs.ca/fr/workshops/' target='_blank'>ateliers R du Centre de la science de la biodiversit√© du Qu√©bec</a>.

[^1]: Un progiciel est un ensemble de fonctions qui servent √† accomplir des t√¢ches. Dans R, on les mets en m√©moire en √©x√©cutant `library(base)` dans la console. Un progiciel s'installe avec la commande `install.packages("dplyr")`.

### Reproduire les analyses

Si vous voulez reproduire les analyses ou suivre le code en m√™me temps, l'ensemble des donn√©es et les scripts de ce projet sont disponibles sur [GitHub : beausoleilmo/guide_biodiv](https://github.com/beausoleilmo/guide_biodiv). Des instructions sont pr√©sentes pour d√©buter avec ce projet.

<!-- [^2]. -->

<!-- [^2]: Les donn√©es sont aussi pr√©sentes sur le site [de l'Open Science Framework (OSF) : Guide d‚Äôidentification de biodiversit√© du Qu√©bec](https://osf.io/92zv4/overview?view_only=528c78edcd814d10a7204e72fdde8490) [@MOBGuideIDBiodiv2025]. Cliquez sur les donn√©es (data.zip), t√©l√©chargez (icone de t√©l√©chargement) et d√©compressez le fichier. La structure des dossiers de donn√©es respecte la structure dans les scripts R. N'h√©sitez pas √† vous pratiquer! Si quelque chose ne tourne pas rond, les commentaires sont bienvenus!  -->

Notez que les progiciels et donn√©es ont leur r√©f√©rence dans le fichier [`ref_blg.bib`](https://github.com/beausoleilmo/evologie/blob/7253741bf2edba6bffb354c396cd53c72c804b48/posts/ref_blg.bib) et sont cit√©s √† la fin de ce billet.

## Recherche de donn√©es

Pour r√©aliser le projet, nous devons trouver des jeux de donn√©es pertinents pour faire une carte et mettre des observations de biodiversit√©. Beaucoup de jeux de donn√©es pour de l'information cartographique administrative ou d√©crivant le territoire sont disponibles sur [Donn√©es Qu√©bec (DQC)](https://www.donneesquebec.ca). Pour la biodiversit√©, le [Global Biodiversity Information Facility (GBIF) ou Syst√®me mondial d'information sur la biodiversit√© (SMIB)](https://www.gbif.org) est **la** source de donn√©es la plus reconnue, en particulier pour les donn√©es de pr√©sence d'esp√®ces Les acronymes (DQC, GBIF, etc.) seront utilis√©s √† c√¥t√© d'un jeu de donn√©es pour conna√Ætre leur source rapidement.

### Donn√©es administratives et du territoire (villes, hydrologie, etc.)

Voici les jeux de donn√©es que je propose pour faire notre carte de base (disponible sur [l'Open Science Framework (OSF)](https://osf.io/92zv4/overview?view_only=528c78edcd814d10a7204e72fdde8490)) :

-   **R√©gions administratives** : [D√©coupages administratifs (DQC)](https://www.donneesquebec.ca/recherche/dataset/decoupages-administratifs/resource/b368d470-71d6-40a2-8457-e4419de2f9c0) [@MRNFDecAdmin2018] et celles du site [Statistique Canada](https://www12.statcan.gc.ca/census-recensement/2021/geo/sip-pis/boundary-limites/index2021-fra.cfm?year=21) pour les limites du recensement du Canada (voir *Recensement de 2021 - Fichiers des limites* [@statistiquecanadaRecensement2021Fichier2025]);
-   **Hydrologie** : [G√©obase du r√©seau hydrographique du Qu√©bec (GRHQ; DQC)](https://www.donneesquebec.ca/recherche/fr/dataset/grhq) [@MRNFGeobaseResHydro2019];
-   **R√©f√©rence √©cologique** du Qu√©bec avec information sur les biomes : [Classification √©cologique du territoire qu√©b√©cois (DQC)](https://www.donneesquebec.ca/recherche/dataset/systeme-hierarchique-de-classification-ecologique-du-territoire/resource/b336d842-9f1d-4d0e-88c1-d771d8ade785) [@MRNFClassEcoTerritoire2016];
-   **Villes et toponymie** : Quelques donn√©es provenant du [portail de donn√©es des portraits climatiques d'Ouranos](https://portraits.ouranos.ca/fr/spatial?a=0&c=0&discrete=1&e=CMIP6&fro=1&i=tg_mean&mun=0&p=50&r=qc000&s=annual&scen=ssp370&w=0&yr=2071) pour le nom des villes et la population de celles-ci [@ouranosPlaces2024]. Par contre, la *Base de donn√©es toponymiques du Canada (BDTC)* pourrait √™tre utilis√©e pour le Canada et s√©lectionner les villes, les parcs ou autres entit√©s ayant un toponyme [@GouvCanRessNatCan2025]. Ce dernier jeu de donn√©es contient des r√®gles d'affichage des √©tiquettes de toponymie selon l'√©chelle, mais nous allons pas utiliser celui-ci dans ce tutoriel.

### Donn√©es de biodiversit√© de science citoyenne

Pour les donn√©es de biodiversit√©, il existe aussi plusieurs sources. D'abord, il y a le [Global Biodiversity Information Facility (GBIF)](https://www.gbif.org) qui contient en date d'octobre 2025, plus de 43¬†millions de donn√©es de pr√©sences d'individus pour le Qu√©bec (vous pouvez aller voir cette information directement sur le [site web GBIF avec le filtre de r√©gion](https://www.gbif.org/occurrence/search?occurrence_status=present&gadm_gid=CAN.11_1)). Les donn√©es de biodiversit√© du Qu√©bec seront explor√©es dans la deuxi√®me partie de cette s√©rie.

-   **Points d'observations eBird** : voir la [documentation ici](https://support.ebird.org/en/support/solutions/articles/48001009443-ebird-hotspot-faqs#anchorAllHotspots) pour acc√©der aux donn√©es. J'en reparlerai plus tard dans le billet;
-   **Donn√©es de pr√©sence d'esp√®ces** : [GBIF](https://www.gbif.org) qui peuvent √™tre accessibles directement sur le site web ou avec le [progiciel `rgbif`](https://docs.ropensci.org/rgbif/index.html) [@R-rgbif].

Aussi, il pourrait √™tre int√©ressant d'avoir des informations sur la taille des organismes et autres traits morphologiques. Au lieu d'aller chercher ces valeurs individuellement, des bases de donn√©es sont d√©j√† disponibles, pour les oiseaux [@tobiasAVONETMorphologicalEcological2022] et plus g√©n√©ralement pour les mammif√®res et les reptiles [@myhrvoldAmnioteLifehistoryDatabase2015].

-   **Traits des esp√®ces** (optionnel) : [AVONET pour les oiseaux](https://figshare.com/s/b990722d72a26b5bfead) [@tobiasAVONETMorphologicalEcological2022] ou une [base de donn√©es des oiseaux, mammif√®res et reptiles](https://www.esapubs.org/archive/ecol/E096/269/) [@myhrvoldAmnioteLifehistoryDatabase2015].

Finalement, des portails de science citoyenne, comme <a href='https://inaturalist.ca' target='_blank'>iNaturalist</a>, permettent d'enregistrer des observations de la nature. Un des fondements de cette plateforme est d'avoir des preuves (photos ou enregistrement sonore) d'observation que la communaut√© peut identifier. Nous pourrions donc extraire des photos et finaliser notre projet de d√©pliant.

-   **Photos des esp√®ces** (optionnel) : <a href='https://inaturalist.ca' target='_blank'>iNaturalist</a> avec le [progiciel `rinat`](https://github.com/ropensci/rinat) [@R-rinat].

## La cartographie

Pour cette premi√®re partie, nous allons produire deux cartes pour le d√©pliant :

1.  une carte couvrant l'ensemble du territoire du Qu√©bec afin d'offrir un contexte g√©n√©ral,
2.  une carte √† plus fine √©chelle, mettant en √©vidence les principaux points d‚Äôint√©r√™t en mati√®re de biodiversit√© pour les r√©gions de Montr√©al et Laval.

<!-- Notre plan de match est de pr√©parer notre session R pour avoir les progiciels et fonctions n√©cessaires pour faire tourner nos scripts. Ensuite, nous allons produire notre carte de fond et une carte avec des points d'observation de biodiversit√©. -->

<!-- √Ä noter ici que les scripts que vous voyez sont le r√©sultat de la recherche et non une explication de tout le d√©veloppement des scripts et toutes les r√©flexions. -->

## Pr√©paration de l'environnement R {#sec-prepenv}

Tout d'abord, nous devons pr√©parer l'environnement de travail R. Une proc√©dure d√©taill√©e est disponible sur le [projet GitHub beausoleilmo/guide_biodiv](https://github.com/beausoleilmo/guide_biodiv) dans le fichier `README.md`. En voici les grandes lignes.

```{r prep_path, echo=FALSE}
# Charge selon la position du chemin d'acc√®s 
# Si le nom du projet n'est pas dans le chemin d'acc√®s active, il sera chang√©
if (!grepl(pattern = '2025_05_24_Guide_biodiv_qc', x = getwd())) {
  # Source l'incubateur d'id√©es 
  source(file = '.InCubateur/2025_05_24_Guide_biodiv_qc/scripts/00_init/00_initialize.R')
} else {
  source(file = 'scripts/00_init/00_initialize.R')
}
```

L'environnement de travail a √©t√© captur√© avec le progiciel `renv`, ce qui permet d'avoir les m√™mes versions de progiciels R pour ce tutoriel.

```{r renv_prep, eval=FALSE, echo=FALSE}
library(renv)
# renv::init()   # cr√©ation de l'espace 
renv::snapshot() # Enregistre la session actuelle
```

Pour restaurer l'environnement de travail, un fichier `renv.lock` avec l'environnement de travail reproductible permet de pr√©parer votre session R en installant les progiciels utilis√©s avec les m√™mes versions pour ce tutoriel. Avec le progiciel `renv`, utilisez `renv::restore()` pour recr√©er cet espace.

```{r renv_install, eval=FALSE, echo=TRUE}
renv::restore() # Permet de restaurer la session avec les m√™mes versions
```

J'ai plac√© les progiciels R et autres scripts √† appeler dans `00_initialize.R`.

```{r lire_prep_script, eval=FALSE}
# Lire le script de pr√©paration automatiquement
source(file = 'scripts/00_init/00_initialize.R')
```

Celui-ci chargera les progiciels (vous devez tout de m√™me installer les progiciels ou ¬´¬†*library*¬†¬ª avant!) et mettra en m√©moire des fonctions pour faire nos analyses. La structure du fichier ressemble √† cela :

```{r eval=FALSE}
# Description ------

# [...]

# Cr√©ation des dossiers ------
dir.create(...)

# Progiciels R ------
library(...)

# Charge les fonctions ------
source('abcdef.R')

# [...]

```

J'ai construit le script `00_initialize.R` √† mesure que je d√©veloppais le projet. C'est pratique puisque pour un nouveau script, je peux simplement l'appeler (avec `source()`) et toutes les fonctions n√©cessaires seront √† ma disposition.

Les principaux progiciels pour ce projet sont ici :

-   `ggplot2` pour faire des graphiques et des cartes [@ggplot22016; @R-ggplot2],
-   `dplyr` pour la manipulation de donn√©es [@R-dplyr],
-   `sf` pour l'analyse spatiale [@sf2023; @sf2018; @R-sf],
-   `mapview` pour faires cartes interactives simples [@R-mapview] et
-   `rgbif` [@R-rgbif] et rinat [@R-rinat] pour la manipulation de donn√©es de biodiversit√©.

Nous allons maintenant pr√©parer le terrain pour faire notre carte de base.

## 1.1 Cartographie

Lorsqu'on fait des cartes, un fond permet de contextualiser l'information avec des marqueurs spatiaux (d√©limitation d'une r√©gion administrative, lacs ou cours d'eau importants, une ville, etc.). Aussi, les donn√©es du fond de la carte sont parfois pertinentes pour faire des manipulations spatiales. Par exemple, il arrive de recouper le territoire par des noms connus (r√©gions administratives), de faire un sommaire en fonction de r√©gions connues ou d'appliquer des filtres √† l'√©chelle d'une MRC.

### Carte : r√©gions administratives du Qu√©bec

Les d√©limitations des MRC du Qu√©bec sont disponibles sur Donn√©es Qu√©bec sous [D√©coupages administratifs (DQC)](https://www.donneesquebec.ca/recherche/dataset/decoupages-administratifs/resource/b368d470-71d6-40a2-8457-e4419de2f9c0). Le fichier qui nous int√©resse est `mrc_s.shp` : ce sont les polygones des MRC du Qu√©bec. L'original est un Shapefile. Mais je trouve cela plus √©l√©gant de mettre cela en g√©opackage (`.gpkg`), puisque tout se retrouve dans un seul fichier. De plus, les g√©opackages offrent plusieurs avantages par rapport √† d'autres types de fichiers comme les Shapefiles.x Le script `scripts/partie_1/Preparation_admin_region.R` montre comment.

```{r prep_donnees_adminreg, eval=FALSE}
# Fonctionne si vous t√©l√©chargez les jeux de donn√©es originaux localement. 
source(file = 'scripts/partie_1/Preparation_admin_region.R')
```

Le progiciel `sf` permet de lire des fichiers pour nos analyses spatiales [@R-sf; @sf2018; @sf2023].

```{r region_admin_qc, echo=TRUE, eval=TRUE}
# Charger le g√©opackage 
regqc = sf::st_read(
  # DSN : data source name
  dsn = "data/partie_1/admin_geo/admin_reg_qc/mrc_s.gpkg", 
  quiet = TRUE
) 
```

Regardons les premi√®res lignes du jeu de donn√©es :

```{r head_reg_qc}
# S√©lection de colonnes
regqc |> 
  dplyr::select(
    MRS_NM_MRC, 
    MRS_NM_REG
  ) |> 
  # Extraction de quelques lignes
  head(n = 3)
```

Il serait int√©ressant de voir les donn√©es sur une carte rapidement. Le progiciel [`mapview`](https://r-spatial.github.io/mapview/) est utile pour faire une carte interactive et colorier les MRC [@R-mapview].

```{r carte_interactive_qc_mrc, eval=TRUE}
# Faire une carte interactive.
mapview::mapview(
  x = regqc, 
  zcol = 'MRS_NM_MRC', # Les couleurs repr√©sentent les MRCs
  legend = FALSE       # Ne pas ajouter de l√©gende 
) 
```

Maintenant, regardons les donn√©es cartographiques qui repr√©sentent le territoire selon la nature de la v√©g√©tation.

### Carte : domaines bioclimatiques

Les donn√©es de la [Classification √©cologique du territoire qu√©b√©cois (DQC)](https://www.donneesquebec.ca/recherche/dataset/systeme-hierarchique-de-classification-ecologique-du-territoire/resource/b336d842-9f1d-4d0e-88c1-d771d8ade785) vont nous donner un fond √† mettre sur notre carte.

Je n'ai pas gard√© le fichier complet puisque les donn√©es sont tr√®s lourdes. Le script `scripts/partie_1/Preparation_eco_region.R` pr√©pare les donn√©es originales en un plus petit g√©opackage (`classification_eco.gpkg`) pour ce projet.

```{r prep_donnees_eco_reg, eval=FALSE}
# Fonctionne si vous t√©l√©chargez les jeux de donn√©es originaux localement. 
source(file = 'scripts/partie_1/Preparation_eco_region.R')
```

Les donn√©es simplifi√©es sont mises en m√©moire avec `st_read()`.

```{r donnees_class_Eco_gpkg}
cls_eco = st_read(
  dsn = "data/partie_1/ecologie/CLASSI_ECO_QC/classification_eco.gpkg", 
  layer = 'N3_DOM_BIO', 
  quiet = TRUE
)
```

Puis nous allons utiliser le syst√®me de coordonn√©es ou CRS (*coordinate reference system*) de la couche de domaines bioclimatiques comme r√©f√©rence pour toutes les couches de notre projet.

```{r donnees_class_Eco_CRS}
# Obtenir notre CRS chouchou et l'utiliser comme base pour faire la carte 
projetCRS = st_crs(x = cls_eco)

# Ce CRS est en fait le code EPSG 32198 qui est un syst√®me de coordonn√©es
# projet√©es 'Conique conforme de Lambert du Qu√©bec' NAD83
projetCRS == st_crs(x = 32198)

# Tester si le CRS est √©quivalent entre des couches 
st_crs(x = cls_eco) == st_crs(x = regqc)

# On transforme le CRS de la r√©gion du Qu√©bec 
regqc_t = st_transform(x = regqc, 
                       crs = projetCRS)
```

Vous pouvez aussi exporter la repr√©sentation *Well-known Text* (WKT) du syst√®me CRS avec `st_as_text()` pour stocker l'information dans un fichier texte.

```{r ecriture_wkt, echo=TRUE, eval=FALSE}
# √âcrire le WKT maitre sur lequel on peut faire r√©f√©rence 
writeLines(
  # Extraire le WKT comme texte seulement 
  text = st_as_text(projetCRS), 
  # Fichier de sortie pour √©crire le texte (aussi appeler 'Connection') 
  con = "data/param_0/projetCRS.txt"
) 

# Lire le fichier CRS maitre  
projetCRS_read  = readLines(con = "data/param_0/projetCRS.txt")

# On peut directement utiliser ce CRS de la r√©gion du Qu√©bec 
regqc_t = st_transform(x = regqc, 
                       crs = projetCRS_read)
```

Nous pouvons superposer les cartes de r√©gions administratives avec la classification des domaines √©cologiques avec `mapview()`. Vous pouvez activer ou d√©sactiver les couches en passant votre curseur sur l'ic√¥ne des couches spatiales (sous les contr√¥les plus et moins pour zoomer dans la carte) et en appuyant sur le bouton √† bascule (boite √† cocher) des couches d√©sir√©es.

```{r carte_Classification_eco_superposition, eval=FALSE}
# R√©gions admin du QC
mapview(
  x = regqc_t, 
  zcol = 'MRS_NM_MRC', 
  layer.name = 'MRC du Qu√©bec',
  # Change la palette de couleur (voir les palettes ici `sort(hcl.pals())`)
  col.regions = hcl.colors(n = nrow(regqc_t), 
                           palette = "Spectral"),
  legend = FALSE
) +
  # Classification √âcologique
  mapview(
    x = cls_eco, 
    zcol = 'NOM_DB', 
    layer.name = 'Domaines biologiques'
  )
```

Je n'ai pas montr√© cette carte puisqu'elle n'est pas vraiment belle puisque les polygones sont superpos√©s et emp√™che de bien voir les d√©tails. Nous pourrions faire une carte qui superpose les *bordures* des r√©gions administratives sur les domaines √©cologiques. C'est ce que nous allons faire avec une carte statique.

### Cartes statiques

Le progiciel `ggplot2` [@ggplot22016; @R-ggplot2] a plusieurs fonctions pour ajouter des couches spatiales (par exemple `geom_sf`). Aussi, `ggplot()` ajoute les couches une par-dessus les autres : donc l'ordre dans lequel les couches sont plac√©es pour faire la carte est important.

Pour que les cartes s'affichent correctement, il faut mettre les couches spatiales dans le m√™me syst√®me de r√©f√©rence spatial ou CRS (*coordinate reference system*). Nous allons aussi utiliser `st_crs()` pour extraire le CRS d'une couche spatiale. Nous pouvons v√©rifier que nos couches spatiales sont dans le m√™me CRS si `st_crs(cls_eco_simp) == st_crs(regqc)` est `TRUE` (ce n'est pas le cas dans l'exemple qui suit).

```{r verification_CRS}
# V√©rification du CRS de couches spatiales (FALSE si diff√©rentes)
st_crs(x = cls_eco) == st_crs(x = regqc)    
# Ici on avait d√©j√† transform√© la couche regqc_t.
st_crs(x = cls_eco) == st_crs(x = regqc_t)  
```

Comme nous l'avons vu, la fonction `sf::st_transform()` nous permet de reprojeter une de nos couches spatiales avec le CRS d'une autre. Avant d'ex√©cuter cette fonction, nous allons aussi simplifier nos couches spatiales. Cela peut √™tre utile si on a des couches spatiales tr√®s d√©taill√©es qui pourraient ralentir `ggplot2`. La fonction `sf::st_simplify()` simplifie nos donn√©es spatiales et donc acc√©l√®re l'affichage des cartes. √Ä noter que la simplification n'est pas n√©cessaire √† faire pour toutes les cartes.

Voici comment simplifier les couches spatiales et rendre le CRS identique entre 2 couches :

```{r simplify_couches}

# Pour la simplification des g√©om√©tries 
# (nombre qui donne un bon r√©sultat suite √† des tests)
tolerance = 1e3

# Simplifier une forme pour faire le graphique 
cls_eco_simp = cls_eco |> 
  st_simplify(dTolerance = tolerance)

# Reprojection pour avoir le m√™me CRS 
regqc_simp = regqc |> 
  st_simplify(dTolerance = tolerance) |> 
  st_transform(crs = projetCRS)

# Ou en utilisation le CRS d'une couche directement 
# au lieu de l'objet 'projetCRS'
regqc_simp = regqc |> 
  st_simplify(dTolerance = tolerance) |> 
  st_transform(crs = st_crs(x = cls_eco))
```

Une fois les couches dans le m√™me syst√®me de r√©f√©rence, nous pouvons dessiner notre carte avec `ggplot()` et `geom_sf()`. Je place chaque couche cartographique dans son objet ce qui facilitera la construction de la carte finale. Cela permet aussi de r√©utiliser des couches entre les graphiques.

```{r ggplot_base}
# Faire le graphique de base ggplot 
gg_base = ggplot()
```

```{r ggplot_couches_carte_statique_qc}
# Couche de domaines bioclimatiques 
gg_cls_eco = geom_sf(
  data = cls_eco,               # Donn√©es 
  mapping = aes(fill = NOM_DB), # couleur selon les domaines biologiques
  alpha = 0.9,                  # Transparence √† 90% 
  linewidth = 0                 # Pas de ligne, plus beau! 
)                

# Couche des r√©gions administratives du Qu√©bec 
gg_reg_qc = geom_sf(
  data = regqc_simp,            # Donn√©es 
  fill = NA,                    # Pas de remplissage des polygones
  colour = 'grey100',           # Couleur des lignes
  linewidth = 0.05              # largeur fine pour les lignes
)
```

Puis on assemble les couches pour faire la carte.

```{r ggplot_carte_cls_eco_reg}
# Ajout des couches ggplot dans l'ordre voulu 
gg_qc_db = gg_base +
  # Ajout de la classification √©cologique
  gg_cls_eco + 
  # Ajout des r√©gions admin, par-dessus pour voir les bordures
  gg_reg_qc
```

Notez que la couche `gg_cls_eco` est dessin√©e en premier et `gg_reg_qc` apr√®s. Cela permet de voir les d√©limitations des r√©gions administratives par-dessus les domaines bioclimatiques. Le graphique est dans l'objet `gg_qc_db`. Notez qu'on ajoute une palette de couleur et change le th√®me de base pour notre carte.

```{r carte_statique_qc_affiche}
# Afficher la carte 
gg_qc_db +          
  # Change le remplissage pour la palette viridis 
  scale_fill_viridis_d(
    # Ajout d'un titre √† la l√©gende 
    guide = guide_legend(title = 'Domaine biologique')
  ) +
  # Th√®me minimal 
  theme_void()
```

Super! Un fond de carte pas pire pour l'ensemble du Qu√©bec! Par contre, il manque quelque chose pour s'y retrouver : l'eau et des villes.

#### Carte : hydrologie et villes

Notre carte de base manque de contexte. Plusieurs endroits au Qu√©bec sont facilement reconnaissables par leur structure hydrologique, ce qui permettrait de mieux se situer sur la carte.

La G√©obase du r√©seau hydrographique du Qu√©bec (GRHQ) est un large ensemble de donn√©es de r√©f√©rence de l'hydrographie disponibles sur le site de [Donn√©es Qu√©bec (DQC)](https://www.donneesquebec.ca/recherche/fr/dataset/grhq). Nous allons seulement t√©l√©charger manuellement les donn√©es pour le sud du Qu√©bec (incluant les zones 00, 01, 02, 03, 04, 05, 06, 07_1, 07_2, 08, 14 de [l'index de t√©l√©chargement (DQC)](https://www.donneesquebec.ca/recherche/dataset/grhq/resource/4ef6703f-0ecb-46a0-bdb4-7074f00ff514)). Un script (`scripts/partie_1/Preparation_hydrologique.R`) permet de pr√©parer les donn√©es en g√©opackage (`data/partie_1/hydro/grhq_sud_qc.gpkg`) pour ce projet. Lors de la pr√©paration pour r√©duire la taille du fichier, j'ai appliqu√© un filtre pour garder les polygones de $1e6 m^2$ d'aire et plus, ce qui permet d'afficher l'essentiel des polygones pour notre carte et de r√©duire consid√©rablement la taille du fichier.

```{r prep_donnees_grhq_prep, eval=FALSE}
# Fonctionne si vous t√©l√©chargez les jeux de donn√©es originaux localement. 
source(file = 'scripts/partie_1/Preparation_hydrologique.R')
```

Les donn√©es pr√©par√©es sont charg√©es et transform√©es avec le m√™me CRS du projet.

```{r charger_donnees_grhq_prep}
# Lire les donn√©es retravaill√©es du GRHQ
hq_filt_complete = st_read(
  dsn = 'data/partie_1/hydro/grhq_sud_qc.gpkg', 
  quiet = TRUE
) |> 
  st_transform(crs = projetCRS)
```

Aussi, nous pourrions inclure le nom de villes avec une grande population sur la carte, ce qui serait super pour visualiser les donn√©es. Le site de [portraits climatiques d'Ouranos](https://portraits.ouranos.ca/fr/) a un fichier qui nous facilitera la t√¢che. Nous pouvons t√©l√©charger les donn√©es directement avec le lien. Nous allons ensuite extraire certaines villes pour afficher sur la carte.

Le script `scripts/partie_1/Preparation_villes.R` pr√©pare un fichier g√©opackage (`data/partie_1/villes/villes_qc_ouranos.gpkg`) que nous pouvons charger directement. Le script importe un fichier `GeoJSON` disponible sur le site d'Ouranos directement √† partir d'un lien html (voir l'objet `lien_villes` dans le script de pr√©paration). La cr√©ation d'un g√©opackage pour ce projet permet de stocker ces donn√©es et d'y faire r√©f√©rence m√™me si le serveur Ouranos change ou devient inaccessible.

```{r prep_donnees_villes_prep, eval=FALSE}
# Fonctionne si vous t√©l√©chargez les jeux de donn√©es originaux localement. 
source(file = 'scripts/partie_1/Preparation_villes.R')
```

Nous pouvons charger notre g√©opackage et s√©lectionner des villes qui nous int√©resse pour mettre sur notre carte.

```{r villes_spatiales, echo=TRUE, eval=TRUE}
# Lecture du fichier des villes et populations du site d'Ouranos
villes_qc = st_read(
  dsn = 'data/partie_1/villes/villes_qc_ouranos.gpkg',
  quiet = TRUE)

# Afficher le nom des villes au besoin 
# sort(villes_qc$name)

# Vecteur avec le nom des villes 
villes_selection = c('Montr√©al', 'Qu√©bec', 
                     'Gatineau', 'Sherbrooke', 
                     'Saguenay', 'Trois-Rivi√®re', 
                     "Rouyn-Noranda", 
                     'Gasp√©', 'T√©miscaming', 
                     'Sept-√éles', 'Rimouski')

# Extraction du nom de villes √† ajouter sur la carte
villes_qc_lst_flt = villes_qc |> 
  filter(name %in% villes_selection)

```

J'ai remarqu√© qu'une partie du r√©seau hydrique de la GRHQ d√©borde en Ontario. Il faut donc extraire ou filtrer les donn√©es qui se retrouvent seulement au Qu√©bec. Le site [Statistique Canada](https://www12.statcan.gc.ca/census-recensement/2021/geo/sip-pis/boundary-limites/index2021-fra.cfm?year=21) permet de t√©l√©charger les limites du recensement du Canada (voir *Recensement de 2021 - Fichiers des limites*). Le script `scripts/partie_1/Preparation_admin_region.R` pr√©pare les donn√©es dans un g√©opackage avec nom `can_lim.gpkg`.

```{r prep_Canada_bordure}
# Lire le fichier 
can_bord = st_read(
  dsn = "data/partie_1/admin_geo/admin_reg_can/can_lim.gpkg", 
  quiet = TRUE
)

# Extraire les limites du Qu√©bec et de l'Ontario 
qcont_bord = can_bord |> 
  # PRFNOM: Nom de la province ou du territoire, en fran√ßais.
  filter(PRFNOM %in% c("Qu√©bec", "Ontario")) |> 
  # Changer le CRS 
  st_transform(crs = projetCRS) 
```

√âtant donn√© qu'une partie du r√©seau hydrique est en Ontario, on fait une intersection pour ¬´¬†couper¬†¬ª les g√©om√©tries selon la province (`st_intersection()`), puis on filtre pour ne garder que le nom de la province de notre choix (`filter()`).

```{r extraire_eau_qc}
# Extraction de l'hydrologie du Qu√©bec seulement
hq_filt_qc = hq_filt_complete |>
  # Intersection avec le fichier de l'Ontario et du Qu√©bec
  st_intersection(qcont_bord) |> 
  # Garder seulement ce qui se retrouve au Qu√©bec
  filter(PRFNOM == "Qu√©bec")
```

Avec cette couche filtr√©e, nous allons cr√©er un objet `geom_sf()` qu'on ajoutera √† la carte.

```{r carte_complete, echo=TRUE, eval=TRUE}
# Couche ggplot de l'hydrologie du Qu√©bec
gg_hq = geom_sf(
  data = hq_filt_qc, 
  linewidth = 0,
  fill = 'lightblue', # Couleur de l'eau 
  colour = 'lightblue'
)

# Ajout le point des villes 
gg_villes = geom_sf(
  data = villes_qc_lst_flt
)
```

Pour ne pas que les √©tiquettes des villes se chevauchent, nous allons utiliser une fonction (`geom_text_repel`) qui utilise des nombres al√©atoires. Pour une reproductibilit√© de la carte, un point de d√©part est choisi pour obtenir des nombres al√©atoires avec `set.seed()`. Ce point de d√©part (*seed*, germe ou graine al√©atoire) est un nombre entier comme `12345` ou `247966138`.

```{r generateur_aleatoire_seed}
# √âtablir le germe al√©atoire
set.seed(seed = 12345)
```

Maintenant, nous avons les informations n√©cessaires pour faire une carte avec :

1.  les domaines biologiques (`gg_cls_eco`),
2.  le r√©seau hydrique d'importance au Qu√©bec (`gg_hq`),
3.  les r√©gions administratives (`gg_reg_qc`),
4.  les points et noms de villes s√©lectionn√©es (`gg_villes` et les √©tiquettes avec `geom_text_repel()`).

Notez encore une fois l'ordre des couches.

```{r ggplot_cartes_geom_simple}
# Faire le graphique de la carte 
gg_qc_db = gg_base +
  # Ajout de la classification √©cologique
  gg_cls_eco + 
  # Ajouter la GRHQ rogn√©e
  gg_hq + 
  # Ajout des r√©gions admin, par-dessus pour voir les bordures
  gg_reg_qc +
  # Ajouter le nom des villes 
  gg_villes + 
  # Ajouter les √©tiquettes du nom des villes 
  ggrepel::geom_text_repel(
    data = villes_qc_lst_flt, 
    # D√©finir les √©tiquettes et les coordonn√©es spatiales 
    mapping = aes(label = name, 
                  geometry = geometry),
    # Extraction des coordonn√©es spatiales pour dessiner les √©tiquettes
    stat = "sf_coordinates", 
    # Taille des √©tiquettes
    size = 3,
    # Ajout de tampon blanc pour les noms de villes 
    bg.color = "white",
    # √âtendue du tampon 
    bg.r = 0.15
  )
```

La carte s'affiche avec l'objet `gg_qc_db`. Nous pouvons ensuite modifier les couleurs de la carte avec `scale_fill_viridis_d()` et sa th√©matique avec `theme_void()` pour partir d'une carte sans th√®me puis modifier l'espacement des items de la l√©gende avec `theme()` et l'argument `legend.key.spacing.y`. La l√©gende (voir `guide_legend()` dans `scale_fill_viridis_d()`) peut aussi √™tre plac√©e en bas (`position = 'bottom'`) pour laisser plus de place √† notre carte.

```{r afficher_carte_ggplot_complet}
# Carte avec th√©matique 
gg_qc_db + 
  # Change le remplissage pour la palette viridis 
  scale_fill_viridis_d(
    guide = guide_legend(
      title = 'Domaine biologique',
      title.position = "top",
      # L√©gende en bas
      position = 'bottom',
      # Nombre de rang√©es pour les √©tiquettes de la l√©gende 
      nrow = 4,
      # Orientation horizontale
      direction = 'horizontal'
    )
  ) +
  # Th√®me au minium 
  theme_void() +
  # Changer l'espacement entre les √©tiquettes de la l√©gende 
  theme(legend.key.spacing.y = unit(x = 0.015, units = "cm"))
```

#### Couper pour le Qu√©bec m√©ridional

Le Qu√©bec est tellement beau et grand! Et justement, il est tellement grand qu'il serait judicieux de se concentrer sur la partie Sud, soit la plus peupl√©e. <!-- Apr√®s tout, nous nous int√©ressons aux endroits qui ont le plus d'observations. -->

Pour ces couches spatiales, nous allons donc extraire la partie sud (m√©ridionale) du Qu√©bec. Celle-ci correspond a 50.5 degr√©s de latitude (axe Y), selon l'Atlas des oiseaux nicheurs du Quebec [-@robertDeuxiemeAtlasOiseaux2019].

Le CRS des domaines biologiques `st_crs(cls_eco)` est en `epsg:32198` ou *NAD83 / Quebec Lambert*. Il faut convertir 50.5 degr√©s en `epsg:32198`. Mais comment? Il y a des convertisseurs en ligne, mais nous pouvons le programmer!

Prenons les limites g√©ographiques du Qu√©bec, ce qu'on appelle la boite limite ou *bounding box* ('bbox') peut s'extrait avec `st_bbox()`. Notre strat√©gie sera d'aller chercher la boite limite en coordonn√©es du *World Geodetic System 1984 (WGS84)* ou `epsg:4326` qui sont en degr√©s.

```{r limites_geo_qc}
# Trouver les limites du Qu√©bec en WSG84
bbox_qc_wsg84 = cls_eco_simp |> 
  st_transform(crs = 4326) |> # Ici on transforme de 32198 vers 4326
  st_bbox()
```

Comparez les limites en *epsg:4326* vs *epsg:32198*.

```{r}
# Boite limite 'bounding box' en epsg:4326 (m√®tres)
bbox_qc_wsg84

# Extraire la boite limite 'bounding box' en epsg:32198 (m√®tres)
(bbox_qc = st_bbox(obj = cls_eco_simp))
```

Ensuite nous trouvons le centre entre la limite de latitude minimum et maximum, puis nous faisons un point au centre et au nord de la limite que nous souhaitons mettre.

```{r trouver_centre_qc}
# Trouver le centre entre xmin et xmax (ou l'√©tendue longitude du Qu√©bec en WSG84)
centre = mean(bbox_qc_wsg84[c('xmin','xmax')])
round(centre, 1) # environ -68.5
```

Puis, un point fictif est cr√©√© avec `st_point()` avec notre centre (longitude = -68.4, pr√®s du m√©ridien central EPSG:32198) et la limite nord (latitude = 50.5). Ce point est transform√© en *epsg:32198*

```{r convertir_pts_gps}
# Faire un point fictif au Qu√©bec
pts = st_point(x = c(centre, 50.5)) |> 
  # Mettre le CRS 
  st_sfc(crs = 4326) |> 
  # Transformer en epsg:32198
  st_transform(crs = projetCRS) |> 
  # Extraire les coordonn√©es seulement 
  st_coordinates()
```

<!-- # Avec terra (voir https://stackoverflow.com/questions/79737412/transformation-of-extent-in-data-is-not-recovered-when-transforming-back-to-the) -->

<!-- lulc.e <- ext(-830291.4, 783722.4, 117964.2, 2090650.1) -->

<!-- target_4326 <- vect(cbind(-69, 50.5), crs = "epsg:4326") -->

<!-- target_32198 <- project(target_4326, "epsg:32198") -->

<!-- new_ymax <- crds(target_32198)[2] -->

<!-- lulc_mer <- ext(lulc.e[1], lulc.e[2], lulc.e[3], new_ymax) -->

<!-- lulc_mer -->

La valeur `Y` de ce point fictif (cr√©√© en *epsg:4326* vers *epsg:32198*) remplacera le `ymax` de l'objet `bbox_qc`. Cette nouvelle boite limite servira √† rogner (`st_crop()`) la carte pour enlever tout ce qui se retrouve au-dessus du 50.5 latitude (ou `pts[2]` = `r formatC(pts[2], format = "f", big.mark = "", digits = 2)` m√®tres selon le `projetCRS`).

```{r boite_limite_meridional}
# Remplacer la valeur de la borne sup√©rieure 
bbox_qc[4] <- pts[2]
```

Nous sommes pr√™ts √† faire notre carte pour le Qu√©bec m√©ridional. Je rogne les couches `cls_eco` et `regqc` (sans simplification) pour avoir les donn√©es les plus propres possible pour la carte finale.

```{r decoupe_carte_qc}
# P√©paration des domaines bioclimatiques pour le Qu√©bec m√©ridional
cls_eco_meridional = cls_eco |> 
  st_transform(crs = projetCRS) |> 
  # boite gabarit pour rogner
  st_crop(y = bbox_qc) |> 
  mutate(
    # Calcul de l'aire de chaque polygone des domaines bioclimatiques
    aire_cls_eco = st_area(geom), 
    # Proportion d'aire pour chaque polygone
    # Note : une polygone (NOM_DB == 'Toundra foresti√®re') est 
    # tr√®s petit et peut √™tre enlev√© sans affecter la visualisation 
    prop = round(aire_cls_eco/sum(aire_cls_eco), 4)*100
  ) |> 
  # Enlever NOM_DB == 'Toundra foresti√®re'
  filter(NOM_DB != "Toundra foresti√®re")

# P√©paration/Rogner des r√©gions administratives pour le Qu√©bec m√©ridional
regqc_meridional = regqc |> 
  st_transform(crs = projetCRS) |> 
  # boite gabarit pour rogner
  st_crop(y = bbox_qc)
```

Puis on refait les couches pour mettre dans le graphique `ggplot2`.

```{r gg_cartes_meridional}
# Domaines biologiques rogn√©s
gg_cls_eco_merid = geom_sf(
  data = cls_eco_meridional,  
  mapping = aes(fill = NOM_DB), # couleur en fonction des domaines biologiques
  alpha = .9,                   # Transparence √† 90% 
  linewidth = 0                 # Pas de ligne, plus beau
)

# R√©gions agministratives rogn√©es 
gg_regqc_merid = geom_sf(
  data = regqc_meridional,  
  fill = NA,                    # Pas de remplissage
  colour = 'grey100',           # Couleur des lignes
  linewidth = 0.05              # Fine ligne
  
)
```

Finalement, on met tout ensemble pour obtenir notre carte du Qu√©bec m√©ridional.

```{r gg_carte_statique_sud_qc}
# √âtablir le germe al√©atoire
set.seed(12345)

# Faire le graphique 
gg_qc_db = gg_base +
  # Domaines biologiques rogn√©s
  gg_cls_eco_merid + 
  # Ajouter la GRHQ rogn√©e
  gg_hq + 
  # Ajout des r√©gions admin, par-dessus pour voir les bordures
  # R√©gions agministratives rogn√©es 
  gg_regqc_merid + 
  # Ajouter le nom des villes 
  gg_villes + 
  # Ajouter le texte du nom des villes 
  ggrepel::geom_text_repel(
    data = villes_qc_lst_flt, 
    mapping = aes(label = name, 
                  geometry = geometry),
    stat = "sf_coordinates", 
    size = 3,
    # Ajout de fond blanc pour les noms de villes 
    bg.color = "white",
    bg.r = 0.15
  ) +   
  # Change le remplissage pour la palette viridis 
  scale_fill_viridis_d(
    guide = guide_legend(
      title = 'Domaine biologique',
      title.position = "top",
      # L√©gende en bas
      position = 'bottom',
      # Nombre de rang√©es pour les √©tiquettes de la l√©gende 
      nrow = 2,
      # Orientation horizontale
      direction = 'horizontal'
    )
  ) +
  # Th√®me au minium 
  theme_void() +
  # Changement d'autres param√®tres du th√®me
  theme(
    # Changer l'espacement entre les √©tiquettes de la l√©gende 
    legend.key.spacing.y = unit(x = 0.015, units = "cm"), 
    # Taille du texte
    legend.text = element_text(size = 7),
    # Taille du titre
    legend.title = element_text(size = 8)
  )
```

Puis on admire notre r√©sultat :

```{r gg_afficher_la_superbe_carte}
# Afficher la carte
gg_qc_db
```

Enfin! Une carte qui a de la gueule. Maintenant, exportons la carte avec `ggsave()`.

```{r exportation_graphique}
# Exportation en PNG
ggsave(
  # Changer l'extension '.png' pour '.pdf' ou '.svg' au besoin. 
  filename = "output/partie_1/carte_domEco_Qc.png", 
  plot = gg_qc_db, 
  width = 6, 
  height = 6, 
  dpi = 300
)
```

## 1.2 Zones critiques de biodiversit√©

### Carte : sites d'observations eBird

Notre carte de fond est pas mal, mais elle ne dit pas grand-chose c√¥t√© biodiversit√©. Un des objectifs du d√©pliant est de pr√©senter les zones critiques de biodiversit√©. Mais o√π seraient situ√©es ces zones? Lorsque les ornithologues amateurs font des observations sur la plateforme eBird, ils enregistrent leurs observations dans des [points de sites publics](https://ebird.org/hotspots) [@eBirdHotspotsGeospatial2025]. Ainsi, les observations enregistr√©es √† ces sites pourraient servir de proxy d'endroits int√©ressants pour la biodiversit√© : s'il y a beaucoup d'esp√®ces d'oiseaux, c'est qu'il doit y avoir beaucoup de nourriture pour soutenir cette diversit√© d'organismes et ainsi, augmenter nos chances de voir d'autres choses int√©ressantes.

Il est possible d'aller cherche ces points de sites publics eBird directement avec l'API de eBird. Le fichier `data/partie_1/biodiv/eBird_hotspots_CA_QC*.csv` a √©t√© obtenu en suivant les explications sous la section '*Is there a list of all eBird Hotspots?*' au lien [eBird Hotspot FAQs](https://support.ebird.org/en/support/solutions/articles/48001009443-ebird-hotspot-faqs). Cela requiert une cl√© API de eBird (voir `VOTRECLEAPI` dans la commande plus bas). Le fichier `eBird regions and region codes_18Apr2023.xlsx` ([t√©l√©chargeable ici](https://support.ebird.org/helpdesk/attachments/48293281603) ) contient les codes r√©gionaux (comme `CA-QC`) et permet de choisir la bonne zone √† t√©l√©charger directement. La commande 'terminal' (en utilisant le langage `bash` et non dans la console R) suivante permet (avec quelques modifications expliqu√©es dans les liens ci-haut) d'obtenir le fichier `eBird_hotspots_CA_QC*.csv` √† jour.

```{bash, eval=FALSE}
# Prendre la date actuelle 
DATE_VAR=$(date -I)
# T√©l√©chargement du fichier des sites publics eBird avec la date de t√©l√©chargement
curl  --header 'X-eBirdApiToken: VOTRECLEAPI' \ 
--location -g 'https://api.ebird.org/v2/ref/hotspot/CA-QC?fmt=csv' > \
eBird_hotspots_CA_QC_${DATE_VAR}.csv
```

Puis, ce ficher `.csv` est import√© et le nom des colonnes ajout√©.

```{r preparation_donnees}
# Mettre les donn√©es des points chauds de eBird en m√©moire
pts_chauds_ebird = "data/partie_1/biodiv/eBird_hotspots_CA_QC_2025-10-13.csv"

# Mettre le fichier en m√©moire 
ebird_hp = read.csv(file = pts_chauds_ebird, 
                    header = FALSE)

# Ajouter un nom aux colonnes 
names(ebird_hp) <- c("locId", 
                     "countryCode", 
                     "subnational1Code", 
                     "subnational2Code", 
                     "lat", "lng",        # Donn√©es spatiales!
                     "locName",           # Nom des sites
                     "latestObsDt",       # Date de la derni√®re observation
                     "numSpeciesAllTime") # Nombre d'esp√®ces 
```

Ce fichier CSV contient de l'information spatiale (`lng`, `lat`). Les fonctions `st_as_sf` et `st_set_crs`, d√©finissent les donn√©es spatiales (POINT) du CSV import√©.

```{r pt_ebirds_sf}
# Pr√©parer les donn√©es spatiales pour une cartographie 
ebird_hp_prep = ebird_hp |>  
  # Mettre tableau en format spatial 
  st_as_sf(coords = c('lng', 'lat')) |> 
  # Choisir le CRS 
  st_set_crs(value = 4326) |>  
  # Formatter la colonne de date 
  mutate(
    date_obs_recent = as.POSIXct(
      latestObsDt,
      format="%Y-%m-%d %H:%M",
      tz = Sys.timezone()
    )
  ) |> 
  # Projection du jeu de donn√©es selon le CRS du projet 
  st_transform(crs = projetCRS) 
```

Pour la cartographie interactive, nous pourrions cr√©er une √©tiquette en combinant le nom des sites de points eBird et le nombre d'esp√®ces dans une nouvelle colonne nomm√©e `labs`. <!-- '<br>' ajoute un retour de ligne  -->

```{r etiquette_ebird_sites_especes}
ebird_hp_sf = ebird_hp_prep |> 
  # Nouvelle colonne d'√©tiquette 
  dplyr::mutate(
    labs = sprintf(
      # Joindre le nom d'un point eBird et le nombre d'esp√®ces.
      fmt = "%s ‚Äî %s sp.", 
      locName, 
      numSpeciesAllTime)
  )
```

Une petite exploration des donn√©es montre qu'en filtrant les sites ayant beaucoup d'esp√®ces (150 et +) et dont la derni√®re visite est apr√®s 2020, on obtient :

```{r exploration_donnees}
ebird_hp_sf |> 
  # Application du filtrer 
  filter(numSpeciesAllTime >= 150,           # Nombre d'esp√®ces
         date_obs_recent >= '2020-01-01') |> # Date 
  nrow()
```

Le chiffre de 150 esp√®ces pourrait aussi √™tre choisi en fonction d'un certain quantile. Avec une probabilit√© de 0.85, on obtient : `r quantile(ebird_hp_sf$numSpeciesAllTime, probs = 0.85, na.rm = TRUE) |> unname()`.

<!-- Les quantiles donne une id√©e de la distribution des valeurs dans les donn√©es.  -->

<!-- ```{r oiseaux_quantiles} -->

<!-- (quant = summary(ebird_hp_sf$numSpeciesAllTime)) -->

<!-- ``` -->

On peut voir que des sites n'ont pas √©t√© visit√©s depuis longtemps avec la carte ci-dessous (notez que si vous t√©l√©chargez les donn√©es eBird longtemps dans le futur, les conclusions seront diff√©rentes)! Cela pourrait √™tre int√©ressant d'aller visiter ces sites et d'ajouter des observations ü¶Ö.

```{r exploration_points_visites_ancien}
# 20 sites avec vieilles dates de visites (pas de liste eBird depuis ce temps!)
sites_perdus = ebird_hp_sf |> 
  # √âtiquette avec l'ann√©e d'observation
  dplyr::mutate(yr_last = substr(latestObsDt, 0,4), 
                labs = sprintf(fmt = "%s ‚Äî %s", yr_last, labs)) |> 
  # Montre les 20 premiers avec les dates les plus petites
  slice_min(order_by = date_obs_recent, 
            n = 20)

# Faire une carte 
mapview(x = sites_perdus, 
        zcol = "yr_last", 
        layer.name = 'Nb Esp.',
        label = "labs")
```

Le code plus bas montre la carte avec tous les points. Cela fait beaucoup de points! Je vous laisse explorer.

```{r exploration_donnees_carte_tous, eval=intermap_slow}
# Pr√©paration des donn√©es simplifier (moins de colonnes)
ebird_hp_sf_simple = ebird_hp_sf |> 
  # S√©lection de colonnes pour l'affichage de d√©tail dans la carte 
  dplyr::select(locId, latestObsDt, numSpeciesAllTime, labs) 

# Regarder les points chauds d'observations eBird 
mapview(
  x = ebird_hp_sf_simple, 
  # Ajout de la couleur en fonction du nombre d'esp√®ces vues
  zcol = 'numSpeciesAllTime',  
  label = "labs",
  layer.name = 'Nb Esp.')
```

On peut aussi r√©pondre √† des questions de coin de table : o√π sont les sites avec plus de 250 esp√®ces diff√©rentes? Promenez le curseur sur les points pour voir plus de d√©tails sur les sites.

```{r ebird_carte_filtre, eval=TRUE}
ebird_hp_chaud = ebird_hp_sf |> 
  dplyr::filter(numSpeciesAllTime >= 250) |> 
  # S√©lection de colonnes pour l'affichage de d√©tail dans la carte 
  dplyr::select(locId, latestObsDt, numSpeciesAllTime, labs)

# Faire la carte 
mapview(
  x = ebird_hp_chaud, 
  zcol = "numSpeciesAllTime", 
  label = "labs",
  labelOptions = leaflet::labelOptions(noHide = FALSE,
                                       opacity = .85, 
                                       textOnly = FALSE),
  layer.name = 'Nb Esp.<br> filtre(>=250)')
```

Avec ce dernier filtre, les points se situent pr√®s de parcs abondamment fr√©quent√©s par les citoyens, et pr√®s des habitations. Aussi, la totalit√© des points se retrouve pr√®s de cours d'eau, marais, r√©servoirs ou un milieu humide. Ce qui d√©montre une fois de plus l'importance des milieux humides pour la biodiversit√©.

Regardons maintenant o√π sont les sites avec plus de 150 observations, peu importe la derni√®re date de visite.

```{r exploration_donnees_carte_filtre_nb, eval=TRUE}
ebird_hp_sf_chaud_bio = ebird_hp_sf |> 
  # S√©lection de colonnes pour l'affichage de d√©tail dans la carte 
  dplyr::select(locId, latestObsDt, numSpeciesAllTime, labs) |> 
  # Regarder seulement les sites qui ont plus de 150 esp√®ces 
  filter(numSpeciesAllTime >= 150)

mapview(
  x = ebird_hp_sf_chaud_bio, 
  zcol = 'numSpeciesAllTime', 
  label = "labs",
  layer.name = 'Nb Esp.<br> filtre(>=150)')
```

Les sites avec le plus d'esp√®ces sont plus au sud. Deux explications rapides :

1.  il y a plus de personnes qui notent des observations au sud du Qu√©bec √† diff√©rents moments dans l'ann√©e, ce qui augmente l'effort d'√©chantillonnage (et donc la probabilit√© de trouver des esp√®ces plus rares).
2.  la diversit√© des oiseaux change en fonction de la latitude. Donc, plus les points se retrouvent dans le nord, moins d'esp√®ces devraient se retrouver. Nous pourrions regarder cela avec un mod√®le lin√©aire. Restons sur les objectifs de notre projet.

Pour avancer √† la prochaine √©tape, il pourrait √™tre int√©ressant de garder les sites avec le plus d'observations pour une MRC (disons environ une vingtaine).

### Zones critiques de biodiversit√© eBird pour une seule r√©gion

Nous avons un probl√®me : aucun point eBird n'est associ√© avec les MRC des r√©gions administratives. Par contre, il est possible de faire une jointure spatiale en utilisant les sites eBirds et les r√©gions du Qu√©bec avec la fonction `st_join()`.

```{r joindre_ebird_pts_admin}
# Joindre les informations de MRC pour chaque point d'observation eBird
eb_qc = ebird_hp_sf |>  
  st_join(y = regqc_t)
```

Nous pouvons exporter ces donn√©es pour les mettre dans un logiciel GIS (comme QGIS), ou les int√©grer √† une base de donn√©es ce qui permettrait d'afficher chaque MRC. Ces donn√©es pourraient servir dans une application Shiny.

```{r exportation_ebird_reg_gpkg}
# Exportation des donn√©es en g√©opackage 
st_write(
  obj = eb_qc, 
  dsn = "output/partie_1/site_pub_ebird_MRC.gpkg", 
  delete_dsn = TRUE,
  quiet = TRUE
)
```

Voici une image montrant les sites eBird avec les MRC dans QGIS en utilisant quelques r√®gles de format d'√©tiquettes pour afficher les sites :

![](images/QGIS_exemple_sites_eBird.png){fig-alt="Sites eBird avec MRC" fig-align="center"}

Pour ce projet, nous allons extraire seulement les 20 sites ayant le plus d'esp√®ces d'oiseaux.

```{r topN_ebird_pts_admin}
# Donne le top n des sites en fonction du nombre d'esp√®ces vues
eb_qc_topn = eb_qc |>  
  # Groupe par MRC pour faire le sommaire (filtration) 
  group_by(MRS_NM_MRC) |> 
  # Extraire 20 points avec le plus d'esp√®ces d'oiseaux par MRC 
  slice_max(n = 20, 
            order_by = numSpeciesAllTime)
```

Puis afficher le r√©sultat pour tout le Qu√©bec sur notre carte interactive.

```{r carte_points_ebird_admin_qc, eval=intermap_slow}
mapview(regqc_t, 
        legend = FALSE, 
        zcol = 'MRS_NM_MRC') + 
  mapview(eb_qc_topn,
          legend = FALSE, 
          cex = 'numSpeciesAllTime',
          zcol = 'MRS_NM_MRC', 
          label = 'locName') 
```

#### Ajout des sites eBird sur la carte de base

√Ä titre d'exemple, nous allons afficher seulement les sites eBirds qui se retrouvent dans l'emprise de Montr√©al et Laval. En utilisant les donn√©es de r√©gions administratives, on peut filtrer et faire une boite limite avec seulement les r√©gions voulues.

```{r grhq_mtl_laval}
# Extraire l'emprise spatiale autour de Montr√©al et Laval 
emprise_region_villes = regqc_t |> 
  filter(MRS_NM_MRC %in% c("Montr√©al", 'Laval')) |> 
  st_bbox()
```

Il faut ensuite rogner les cartes avec :

```{r prepare_couches_carte}

# Rogner l'information hydrologique pour cette r√©gion 
hq_lvl_mtl = hq_filt_qc |> st_crop(y = emprise_region_villes)
reg_mtl = regqc_t |> st_crop(y = emprise_region_villes)

# Prendre les 20 points les plus √©lev√©s en nombre d'esp√®ces pour Montr√©al et Laval 
eb_qc_topn_lvl_mtl = eb_qc_topn |> 
  filter(MRS_NM_MRC %in% c("Montr√©al", 'Laval')) 
```

√Ä noter que si on regarde de tr√®s pr√®s la r√©gion de Montr√©al et Laval, la classification des domaines √©cologiques est assez uniforme. Donc pas besoin de l'ajouter √† notre carte.

Bonus : Pour se rendre √† ces sites, on pourrait y aller en v√©lo? J'utiliserai donc les fichiers spatiaux du [r√©seau cyclable de Montr√©al (DQC)](https://www.donneesquebec.ca/recherche/dataset/vmtl-pistes-cyclables) [@MTLReseauCyclableJeu2013] et les [pistes cyclables et pi√©tonni√®res de Laval (DQC)](https://www.donneesquebec.ca/recherche/dataset/pistes-cyclables-et-pietonnieres) [@villedelavalPistesCyclablesPietonnieres12017]. Cela d√©montre aussi que m√™me les GeoJSON peuvent √™tre import√©s avec sf.

```{r reseau_cyclable_spatial_mtl_lvl}
# Chemin d'acc√®s aux fichiers de r√©seaux cyclables
res_cycl = "data/partie_1/infrastructure/res_cyclable"
lien_res_cycl_mtl = file.path(res_cycl, 'reseau_cyclable.geojson')
lien_res_cycl_lvl = file.path(res_cycl, 'pistes-cyclables-et-pietonnieres.geojson')

res_cyclable_mtl = st_read(dsn = lien_res_cycl_mtl, quiet = TRUE)
res_cyclable_lvl = st_read(dsn = lien_res_cycl_lvl, quiet = TRUE)
```

Il ne reste plus qu'√† faire notre carte!

Je commence par d√©finir une carte de base sans le nom des sites.

```{r carte_mtl_laval}
gg_carte_points_inret_ebird_base = ggplot() + 
  # Polygones des MRCs 
  geom_sf(data = reg_mtl) + 
  # Polygones d'eau
  geom_sf(data = hq_lvl_mtl, fill = 'lightblue') + 
  # Lignes du R√©seau cyclable
  geom_sf(data = res_cyclable_mtl, colour = "#A1D998", alpha = .5) + 
  geom_sf(data = res_cyclable_lvl, colour = "#A1D998", alpha = .5) + 
  # Top Points eBirds
  geom_sf(data = eb_qc_topn_lvl_mtl, 
          aes(size = numSpeciesAllTime, 
              shape = MRS_NM_MRC,
              colour = numSpeciesAllTime)) + 
  # Couleur des points
  scale_colour_viridis_c() +
  # Th√®me minimal 
  theme_void() +
  # Ajout de titre aux l√©gendes
  labs(colour = "Nb esp√®ces", 
       size = "Nb esp√®ces",
       shape = "MRC")
```

On ajoute le nom des sites sur la carte de base.

```{r carte_mtl_laval_avec_sites}
# √âtablir le germe al√©atoire
set.seed(123456)
gg_carte_points_inret_ebird = gg_carte_points_inret_ebird_base +
  # Texte nom des sites 
  ggrepel::geom_text_repel(
    data = eb_qc_topn_lvl_mtl, 
    mapping = aes(label = labs, 
                  geometry = geometry),
    stat = "sf_coordinates", 
    size = 2.25,
    # Ajout de fond blanc pour les noms de villes 
    bg.color = "white",
    bg.r = 0.15) 
```

Puis, on l'affiche.

```{r gg_carte_affiche_sites_ebirds_et_villes}
gg_carte_points_inret_ebird
```

La carte est un peu charg√©e avec tous les longs noms des sites. Je propose donc de faire un petit m√©nage dans les noms longs en enlevant les parties qui sont inutiles de repr√©senter. La fonction `gsub()` permet de faire une sorte de 'recherche et remplacer' comme dans un √©diteur de texte. Je d√©termine en premier des patrons √† retirer (voir l'objet `patt_v`) puis les combines ensemble avec le caract√®re `|` pour trouver tout en m√™me temps (voir l'objet `patt`).

Aussi, je veux un ID unique pour chaque site. Dans le jeu de donn√©es, chaque site a un num√©ro de rang√©e (`row_number()`). J'utilise ce num√©ro comme identifiant.

Finalement, je vais faire une nouvelle √©tiquette en utilisant `sprintf()` avec les num√©ros de lignes et notre nouvelle colonne d'√©tiquettes corrig√©es.

```{r menage_noms_sites_eBird}
# Texte √† rechercher et remplacer 
# pour limiter la taille des √©tiquettes √† afficher
patt_v = c(
  ", Laval", 
  " \\(acc√®s restreint\\)", 
  " \\(aucun acc√®s en voiture\\)", 
  " \\(LISTES HISTORIQUES SEULEMENT; SVP utiliser un site plus pr√©cis pour les listes actuelles\\)")

# Faire un patron de recherche pour tout enlever d'un seul coup
patt = paste0(
  patt_v, 
  collapse = "|"
)

# √Ä partir de notre jeu de donn√©es
eb_qc_topn_lvl_mtl_id = eb_qc_topn_lvl_mtl |> 
  # Enl√®ve les groupes pr√©sents
  ungroup() |> 
  # Ajout des colonnes
  mutate(
    # Chaque site avec nom corrig√©
    site_corr = gsub(   # gsub permet de chercher et remplacer
      pattern = patt,   # Patron de recherche
      replacement = '', # Remplacer par rien 
      x = locName       # De la colonne des noms de sites
    ),
    # Ajoute un num√©ro unique (ici le num√©ro de ligne est suffisant)
    rnb = as.factor(row_number()), # Mettre en facteur met en ordre les chiffres
    # Cr√©ation de nouvelles √©tiquettes 
    site_labs = sprintf(
      fmt = "%s: %s", 
      rnb, site_corr
    ))
```

Notre jeu de donn√©es est maintenant pr√™t √† faire la carte.

```{r gg_carte_affiche_sites_ebirds_et_villes_propre}

# Noter le nombre de lignes dans le jeu de donn√©es 
nrep = nrow(eb_qc_topn_lvl_mtl_id)

# En reprenant la carte de base, on ajoute les √©tiquettes et une l√©gende 
gg_carte_points_inret_ebird = gg_carte_points_inret_ebird_base + # Carte de base
  # Texte nom de villes 
  ggrepel::geom_label_repel(
    # Nouveau jeu de donn√©es 
    data = eb_qc_topn_lvl_mtl_id, 
    # Ajouter les √©tiquettes
    mapping = aes(
      label = rnb,             # √âtiquette sur la carte : seulement des chiffres 
      geometry = geometry,     # O√π vont les √©tiquettes
      fill = factor(site_labs) # La l√©gende sera les √©tiquettes compl√®tes
    ), 
    stat = "sf_coordinates", 
    size = 2.25                # Taille des √©tiquettes sur la carte 
  ) +
  # L√©gende pour le nom des sites 
  scale_fill_manual(
    name = 'Site Name',       # Nom de la l√©gende 
    values = rep(             # Couleur des √©tiquettes 
      scales::alpha("white", 
                    alpha = .5), 
      nrep), 
    labels = eb_qc_topn_lvl_mtl_id$site_labs # Nom des √©tiquettes en ordre 
  ) +
  # Changement de l'apparence de la l√©gende pour les √©tiquettes des sites 
  guides(
    # Red√©finir comment la l√©gende de remplissage affiche 
    fill = guide_legend(
      # Mettre la l√©gende de remplissage en bas 
      position = "bottom",
      # Changer des param√®tres de th√©matique seulement pour la partie de remplissage
      theme = theme(
        # Change la taille du texte des √©tiquettes dans la l√©gende
        legend.text = element_text(size = 8),
        # Change la distance horizontale entre les √©tiquettes de la l√©gende
        legend.key.width  = unit(0.05, "cm"),
        # Change la distance verticale entre les √©tiquettes de la l√©gende
        legend.key.height = unit(0.05, "cm"),
        # Position du titre 
        legend.title.position = "top",
        # Justification √† gauche ==0 (droite ==1, centre == 0.5)
        legend.title = element_text(hjust = 0), 
        # Ajouter une marge pour √©viter de couper le texte 
        legend.margin = margin(
          t = 0,
          r = 0.5,
          b = 1,
          l = 2, 
          unit = 'cm')
      ),
      # Changer la taille des √©tiquettes 
      override.aes = list(
        size = 0, # Change la taille des 'Cl√©s' de la l√©gende
        colour = scales::alpha('black', alpha = 0) # Change la couleur des 'Cl√©s'
      )
    )
  )

```

On affiche le produit.

```{r gg_carte_affiche_sites_ebirds_finale, fig.width=12, fig.height=8, echo=TRUE, eval=FALSE}
gg_carte_points_inret_ebird
```

```{r gg_carte_affiche_sites_ebirds_finale_WEB, fig.width=10, fig.height=10, echo=FALSE, eval=TRUE}
gg_carte_points_inret_ebird_WEB = gg_carte_points_inret_ebird_base + # Carte de base
  # Texte nom de villes 
  ggrepel::geom_label_repel(
    # Nouveau jeu de donn√©es 
    data = eb_qc_topn_lvl_mtl_id, 
    # Ajouter les √©tiquettes
    mapping = aes(
      label = rnb,             # √âtiquette sur la carte : seulement des chiffres 
      geometry = geometry,     # O√π vont les √©tiquettes
      fill = factor(site_labs) # La l√©gende sera les √©tiquettes compl√®tes
    ), 
    stat = "sf_coordinates", 
    size = 5                # Taille des √©tiquettes sur la carte 
  ) +
  # L√©gende pour le nom des sites 
  scale_fill_manual(
    name = 'Site Name',       # Nom de la l√©gende 
    values = rep(             # Couleur des √©tiquettes 
      scales::alpha("white", 
                    alpha = .5), 
      nrep), 
    labels = eb_qc_topn_lvl_mtl_id$site_labs # Nom des √©tiquettes en ordre 
  ) +
  # Changement de l'apparence de la l√©gende pour les √©tiquettes des sites 
  guides(
    # Red√©finir comment la l√©gende de remplissage affiche 
    fill = guide_legend(
      ncol = 3,
      # Mettre la l√©gende de remplissage en bas 
      position = "bottom",
      # Changer des param√®tres de th√©matique seulement pour la partie de remplissage
      theme = theme(
        # Change la taille du texte des √©tiquettes dans la l√©gende
        legend.text = element_text(size = 10),
        # Change la distance horizontale entre les √©tiquettes de la l√©gende
        legend.key.width  = unit(0.05, "cm"),
        # Change la distance verticale entre les √©tiquettes de la l√©gende
        legend.key.height = unit(0.05, "cm"),
        # Position du titre 
        legend.title.position = "top",
        # Justification √† gauche ==0 (droite ==1, centre == 0.5)
        legend.title = element_text(hjust = 0), 
        # Ajouter une marge pour √©viter de couper le texte 
        legend.margin = margin(
          t = 0,
          r = 0.5,
          b = 1,
          l = 2, 
          unit = 'cm')
      ),
      # Changer la taille des √©tiquettes 
      override.aes = list(
        size = 0, # Change la taille des 'Cl√©s' de la l√©gende
        colour = scales::alpha('black', alpha = 0) # Change la couleur des 'Cl√©s'
      )
    )
  )

gg_carte_points_inret_ebird_WEB
```

Puis on exporte l'image.

```{r exportation_carte_eBird_finale}
# Exportation en PNG
ggsave(
  # Changer l'extension '.png' pour '.pdf' ou '.svg' au besoin. 
  filename = "output/partie_1/carte_pt_ebird_Qc.png", 
  plot = gg_carte_points_inret_ebird, 
  width = 10, 
  height = 10, 
  dpi = 300
)
```

Et pour finir une carte interactive!

```{r carte_interactive_ZHPB_ebird}
# On ajoute une √©tiquette avec le nombre d'esp√®ces
zhpb = eb_qc_topn_lvl_mtl_id |> 
  mutate(
    labs2 = sprintf('%s; sp : %s', 
                    site_corr, 
                    numSpeciesAllTime)
    )

# carte interactive pour le plaisir
mapview(
  zhpb, 
  zcol = 'numSpeciesAllTime', 
  layer.name = "NB esp√®ces", 
  label = "labs2"
)
```

Voil√†!

## Prochaines √©tapes

Cette premi√®re partie avait pour but de faire un grand tour dans les fonctions utiles pour faire des analyses spatiales. Ainsi, il est possible d'importer et de manipuler les couches spatiales dans R et de pr√©parer des couches pour en faire des cartes. Vous pouvez toujours exporter les couches et continuer dans votre logiciel GIS pr√©f√©r√© ensuite

Avec ces nouvelles connaissances, il sera plus facile de manipuler les donn√©es de biodiversit√© provenant de GBIF.

### R√©f√©rences

::: {#refs}
:::
